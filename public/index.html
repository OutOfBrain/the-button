<html>
<body>
	<h2>Button Countdown <span id="counter"></span></h2>
	<div id="loading" style="margin:50px;margin-left:150px">Loading - might take a few seconds</div>
	<div id="placeholder" style="width:1000px;height:500px"></div>

	<div style="background-color:lightgray;display:inline-block;padding:15px 25px 15px 25px;margin-left:40px" title="Untick for live view">
		<label for="history">Include History (grouped by minimum per 60 seconds):</label><input id="history" name="history" type="checkbox" checked />
		<!-- Why even bother -->
		<!--<label for="allDataPoints">Include History All Datapoints (extremely slow):</label><input id="allDataPoints" name="allDataPoints" type="checkbox" />-->
	</div>

	<div style="padding:15px 25px 15px 40px">Data available here: <a href="button.csv">button.csv</a></div>

	<div id="fallback_container" style="display:none">
		<div>
			<label for="fallback_url">Fallback URL:</label>
			<input id="fallback_url" type="text" maxlength="120" />
			<button id="fallback_do">Do It!</button>
		</div>
		<div>
			How to?
			<img src="http://i.imgur.com/aGBjsLR.png" />
		</div>
	</div>

	<div id="fallback_success_container" style="display:none;color:green">Yay! that worked =)</div>


	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/flot/0.8.3/jquery.flot
.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/flot/0.8.3/jquery.flot.time.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/flot/0.8.3/jquery.flot.navigate.min.js"></script>
	<script type="text/javascript">
		var constFilterGroupTime = 60;
		var constLimitLiveViewDataPoints = 600;

		var plotData = [];  // the drawn plot data - combines historyCompleteData + liveData
		var liveData = [];  // data loaded from websocket since opening page
		var historyCompleteData = [];  // historic data from server
		var historyFilteredData = [];  // history data from server

		var flagAllDataPoints = false;  // flag to choose between the complete history and the filtered one
		var flagShowHistory = true;  // flag to display history or not

		// setup plot
		var plot = $.plot("#placeholder", [ plotData ], {
			series: {
				shadowSize: 0
			},
			grid: {
				hoverable: true,
				clickable: true
			},
			yaxis: {
				min: 0,
				max: 60
			},
			xaxis: {
				mode: "time",
				timezone: "browser",
				timeformat: "%Y-%m-%d %H:%m:%S"
			},
			zoom: {
				interactive: true
			},
			pan: {
				interactive: true
			}
		});

		$("#placeholder").bind("plothover", function (event, pos, item) {
			var str = "(" + pos.x.toFixed(2) + ", " + pos.y.toFixed(2) + ")";
			$("#hoverdata").text(str);

			if (item) {
				var x = item.datapoint[0];
				var y = item.datapoint[1];

				$("#tooltip").html(y + '<br>')
					.css({top: item.pageY+5, left: item.pageX-23})
					.fadeIn(200);
			} else {
				$("#tooltip").hide();
			}
		});
		$("<div id='tooltip'></div>").css({
			position: "absolute",
			display: "none",
			border: "1px solid #fdd",
			padding: "2px",
			"background-color": "#fee",
			opacity: 0.80
		}).appendTo("body");

		/**
		 * Called on websocket receive live data.
		 */
		function update(event) {
			if (event == undefined) {
				return;
			}
//				{"type": "ticking", "payload": {"participants_text": "520,984", "tick_mac": "7e010014dd1d86ca7f8b76106b598a90db7429f5", "seconds_left": 59.0, "now_str": "2015-04-03-00-50-07"}}
			var data = JSON.parse(event.data);
			var seconds_left = data.payload.seconds_left;
			var now_str = data.payload.now_str;

			$('#counter').html(seconds_left);

			var ts = now_str.split('-');
			var year = ts[0];
			var month = ts[1];
			var day = ts[2];
			var hour = ts[3];
			var minute = ts[4];
			var second = ts[5];
			var now_timestamp = Date.parse(year+'-'+month+'-'+day+' '+hour+':'+minute+':'+second+' UTC');

			liveData.push([now_timestamp, seconds_left]);
			if (!flagShowHistory && !flagAllDataPoints) {
				// special case that we are just looking at the live view - limit the data points in that case
				if (plotData.length > constLimitLiveViewDataPoints) {
					plotData.shift();
				}
			}
			plotData.push([now_timestamp, seconds_left]);
			refreshPlot();
		}

		/**
		 * Redraw the graph.
		 */
		function refreshPlot() {
			plot.setData([plotData]);
			plot.setupGrid();
			plot.draw();
		}

		// prepend csv data to the plot
		$.ajax({
			type: "GET",
			url: "button.csv",
			dataType: "text",
			success: function(data) {
				var lines = data.split(/\n/);
				lines.shift();  // remove header
				lines.pop();  // remove last line - is empty

				var len = lines.length;
				var elements = [];
				for (var i = 0; i < len; ++i) {
					elements = lines[i].split(/,/);

					// * 1000 since milliseconds are used
					var now_timestamp = parseInt(elements[0]) * 1000;
					var seconds_left = parseInt(elements[2]);
					historyCompleteData.push([now_timestamp, seconds_left]);
				}
				recalculateFilter(constFilterGroupTime);
				toggleHistory(true);

				$('#loading').hide();
			}
		});

		/**
		 * Prepares the filtered data for plotting.
		 * Uses the full history as base.
		 * Can be called from console to change the grouping
		 * - just call flagShowHistory(true) after to force setting data and redraw.
		 */
		function recalculateFilter(groupBySeconds) {
			historyFilteredData = [];
			var len = historyCompleteData.length;
			var min_now_timestamp = historyCompleteData[0][0];
			var min_seconds_left = historyCompleteData[0][1];
			for (var i = 0; i < len; ++i) {
				if (i % groupBySeconds == 0) {
					// timeframe over - found our minimum. reset min seconds to 60
					historyFilteredData.push([min_now_timestamp, min_seconds_left]);
					min_seconds_left = 60;
				} else if (historyCompleteData[i][1] < min_seconds_left) {
					// found lover second value in time frame - store plus timestamp
					min_seconds_left = historyCompleteData[i][1];
					min_now_timestamp = historyCompleteData[i][0];
				}
			}
		}

		/**
		 * Recalculate the plotData which consists of the history and the live data.
		 * The prepended history is optional and en-/disabled with this function.
		 */
		function toggleHistory(historyOn) {
			flagShowHistory = historyOn;  // just used to track history toggle state
			if (historyOn) {
				if (flagAllDataPoints) {
					plotData = [].concat(historyCompleteData, liveData);
				} else {
					plotData = [].concat(historyFilteredData, liveData);
				}
			} else {
				plotData = liveData;
			}
			refreshPlot();
		}

		// listen to history toggle change
		$('#history').change(function() {
			if($(this).is(":checked")) {
				// with history
				toggleHistory(true);
			} else {
				// without history
				toggleHistory(false);
			}
		});

		// listen history filter
		$('#flagAllDataPoints').change(function() {
			flagAllDataPoints = $(this).is(":checked");
			toggleHistory(true);
		});

		var was_error = false;
		function initWebSocket(url) {
			// start the websocket connection
			var webSocket = new WebSocket(url);
			webSocket.onmessage = update;
			webSocket.onerror = function() {
				was_error = true;
				// display fallback container:
				$('#fallback_container').show();
				$('#fallback_do').click(function(){
					var fallback_url = $('#fallback_url').val();
					console.log("try again with " + fallback_url);
					initWebSocket(fallback_url)
				});
			};

			webSocket.onopen = function() {
				if (was_error) {
					was_error = false;
					$('#fallback_container').hide();
					$('#fallback_success_container').show();
				}
			}
		}
		initWebSocket('wss://wss.redditmedia.com/thebutton?h=5659ab4a9faae1313b8cd1599bba55baac3a3822&e=1428280377');
	</script>

	<script>
		// just want to know if anyone used it
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
				m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-3345271-13', 'auto');
		ga('send', 'pageview');

	</script>
</body>
</html>
