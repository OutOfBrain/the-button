<html>
<body>
	<h2>Button Countdown</h2>
	<div id="loading" style="margin:50px;margin-left:150px">Loading - might take a few seconds</div>
	<div id="placeholder" style="width:1000px;height:500px"></div>

	<div style="background-color:lightgray;display:inline-block;padding:15px 25px 15px 25px;margin-left:40px" title="Untick all for live view">
		<label for="history">Include History (grouped by minimum per 60 seconds):</label><input id="history" name="history" type="checkbox" checked />
		<label for="allDataPoints">Include History All Datapoints (extremely slow):</label><input id="allDataPoints" name="allDataPoints" type="checkbox" />
	</div>

	<div style="padding:15px 25px 15px 40px">Data available here: <a href="button.csv">button.csv</a></div>


	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/flot/0.8.3/jquery.flot.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/flot/0.8.3/jquery.flot.time.js"></script>
	<script type="text/javascript">
		$(function() {
			var plotData = [];  // the drawn plot data - combines historyCompleteData + liveData
			var liveData = [];  // data loaded from websocket since opening page
			var historyCompleteData = [];  // historic data from server
			var historyFilteredData = [];  // history data from server

			var allDataPoints = false;  // flag to choose between the complete history and the filtered one

			// setup plot
			var plot = $.plot("#placeholder", [ plotData ], {
				series: {
					shadowSize: 0
				},
				yaxis: {
					min: 0,
					max: 60
				},
				xaxis: {
					mode: "time",
					timezone: "browser",
					timeformat: "%Y-%m-%d %H:%m:%S"
				}
			});

			/**
			 * Called on websocket receive live data.
			 */
			function update(event) {
				if (event == undefined) {
					return;
				}
//				{"type": "ticking", "payload": {"participants_text": "520,984", "tick_mac": "7e010014dd1d86ca7f8b76106b598a90db7429f5", "seconds_left": 59.0, "now_str": "2015-04-03-00-50-07"}}
				var data = JSON.parse(event.data);
				var seconds_left = data.payload.seconds_left;
				var now_str = data.payload.now_str;

				var ts = now_str.split('-');
				var year = ts[0];
				var month = ts[1];
				var day = ts[2];
				var hour = ts[3];
				var minute = ts[4];
				var second = ts[5];
				var now_timestamp = Date.parse(year+'-'+month+'-'+day+' '+hour+':'+minute+':'+second+' UTC');

				liveData.push([now_timestamp, seconds_left]);
				plotData.push([now_timestamp, seconds_left]);
				refreshPlot();
			}

			/**
			 * Redraw the graph.
			 */
			function refreshPlot() {
				plot.setData([plotData]);
				plot.setupGrid();
				plot.draw();
			}

			// prepend csv data to the plot
			$.ajax({
				type: "GET",
				url: "button.csv",
				dataType: "text",
				success: function(data) {
					var lines = data.split(/\n/);
					lines.shift();  // remove header
					lines.pop();  // remove last line - is empty

					var len = lines.length;
					var elements = [];
					for (var i = 0; i < len; ++i) {
						elements = lines[i].split(/,/);

						// * 1000 since milliseconds are used
						var now_timestamp = parseInt(elements[0]) * 1000;
						var seconds_left = parseInt(elements[2]);
						historyCompleteData.push([now_timestamp, seconds_left]);
					}
					toggleHistory(true);

					$('#loading').hide();
				}
			});

			/**
			 * Recalculate the plotData which consists of the history and the live data.
			 * The prepended history is optional and en-/disabled with this function.
			 */
			function toggleHistory(historyOn) {
				if (historyOn) {
					if (allDataPoints) {
						plotData = [].concat(historyCompleteData, liveData);
					} else {
						// filter data - minimum over every 5 minutes
						historyFilteredData = [];
						var len = historyCompleteData.length;
						var min_now_timestamp = historyCompleteData[0][0];
						var min_seconds_left = historyCompleteData[0][1];
						for (var i = 0; i < len; ++i) {
							if (i % 60 == 0) {
								historyFilteredData.push([min_now_timestamp, min_seconds_left]);
								min_seconds_left = 60;
							} else if (historyCompleteData[i][1] < min_seconds_left) {
								min_seconds_left = historyCompleteData[i][1];
								min_now_timestamp = historyCompleteData[i][0];
							}
						}
						console.log(historyFilteredData);
						plotData = [].concat(historyFilteredData, liveData);
					}
				} else {
					plotData = liveData;
				}
				refreshPlot();
			}

			// listen to history toggle change
			$('#history').change(function() {
				if($(this).is(":checked")) {
					// with history
					toggleHistory(true);
				} else {
					// without history
					toggleHistory(false);
				}
			});

			// listen history filter
			$('#allDataPoints').change(function() {
				allDataPoints = $(this).is(":checked");
				toggleHistory(true);
			});

			// start the websocket connection
			var webSocket = new WebSocket('wss://wss.redditmedia.com/thebutton?h=5f2bc40bb2a4a316bf8069d7e0cbc664682630bd&e=1428104402');
			webSocket.onmessage = update;
		});
	</script>

	<script>
		// just want to know if anyone used it
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
				m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-3345271-13', 'auto');
		ga('send', 'pageview');

	</script>
</body>
</html>
